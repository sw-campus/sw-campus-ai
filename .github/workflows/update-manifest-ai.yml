name: Update Manifest (AI)

on:
  workflow_run:
    workflows: ["Build & Push AI Image"]
    types:
      - completed

permissions:
  contents: read

jobs:
  update-manifest:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1) AI 레포 체크아웃 (태그 계산용)
      - name: Checkout AI repo
        uses: actions/checkout@v4

      # 2) 이미지 태그 결정
      - name: Determine image tag
        id: tag
        run: |
          REF="${{ github.event.workflow_run.head_branch }}"

          if [ "$REF" = "main" ]; then
            TAG="latest"
          else
            TAG="${{ github.event.workflow_run.head_sha }}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # 3) 대상 manifest 브랜치 결정
      - name: Determine target manifest branch
        id: target
        run: |
          REF="${{ github.event.workflow_run.head_branch }}"

          if [ "$REF" = "develop" ]; then
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "env=dev" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "env=prod" >> $GITHUB_OUTPUT
          fi

      # 4) manifest 레포 체크아웃
      - name: Checkout manifest repo
        uses: actions/checkout@v4
        with:
          repository: sw-campus/sw-campus-manifest
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          path: manifest

      # 5) AI deployment 이미지 태그 변경
      - name: Update AI deployment image
        run: |
          cd manifest
          sed -i "s|image: .*sw-campus-ai:.*|image: ghcr.io/sw-campus/sw-campus-ai:${{ steps.tag.outputs.tag }}|g" \
            k8s/ai/deployment.yaml

      # 6) PR 생성
      - name: Create PR to manifest repo
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_MANIFEST_TOKEN }}
          path: manifest
          commit-message: "chore(ai): update image (${{ steps.target.outputs.env }}) to ${{ steps.tag.outputs.tag }}"
          title: "Deploy AI (${{ steps.target.outputs.env }}) – ${{ steps.tag.outputs.tag }}"
          body: |
            - Service: AI
            - Environment: ${{ steps.target.outputs.env }}
            - Image tag: `${{ steps.tag.outputs.tag }}`
          base: ${{ steps.target.outputs.branch }}
          branch: chore/ai-image-${{ steps.target.outputs.env }}-${{ steps.tag.outputs.tag }}
          add-paths: |
            k8s/ai/deployment.yaml
