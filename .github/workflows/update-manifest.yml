name: Update Manifest

on:
  workflow_run:
    workflows: ["Build Dev Image", "Build Release"]
    types:
      - completed

permissions:
  contents: read
  packages: write

jobs:
  update-manifest:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1) AI 레포 체크아웃 (태그 계산용)
      - name: Checkout AI repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # 2) 어떤 workflow에서 트리거되었는지 확인
      - name: Determine trigger source
        id: source
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          echo "Triggered by: $WORKFLOW_NAME"
          
          if [ "$WORKFLOW_NAME" = "Build Release" ]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      # 3) 이미지 태그 결정
      - name: Determine image tag
        id: tag
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          
          if [ "${{ steps.source.outputs.is_release }}" = "true" ]; then
            # Release workflow에서 트리거 → pyproject.toml에서 버전 읽기
            VERSION=$(grep "^version = " pyproject.toml | cut -d'"' -f2)
            VERSION_TAG="v${VERSION}"
            echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT
            echo "Release tag: $VERSION_TAG"
          else
            # Build Dev Image (develop) → RHSA 태그
            echo "tag=RHSA-$SHA" >> $GITHUB_OUTPUT
            echo "Dev tag: RHSA-$SHA"
          fi

      # 4) 대상 manifest 브랜치 결정
      - name: Determine target manifest branch
        id: target
        run: |
          if [ "${{ steps.source.outputs.is_release }}" = "true" ]; then
            echo "branch=release" >> $GITHUB_OUTPUT
            echo "env=prod" >> $GITHUB_OUTPUT
          else
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "env=dev" >> $GITHUB_OUTPUT
          fi

      # 5) manifest 레포 체크아웃
      - name: Checkout manifest repo
        uses: actions/checkout@v4
        with:
          repository: sw-campus/sw-campus-manifest
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          path: manifest

      # 6) AI 이미지 태그 변경
      - name: Update AI image tag
        run: |
          cd manifest
          if [ "${{ steps.target.outputs.branch }}" == "develop" ]; then
            VALUES_FILE="k8s/environments/develop/values.yaml"
          else
            VALUES_FILE="k8s/environments/release/values.yaml"
          fi
          sed -i '/repository: ghcr.io\/sw-campus\/sw-campus-ai$/,/pullPolicy:/ s|tag: ".*"|tag: "${{ steps.tag.outputs.tag }}"|' "$VALUES_FILE"

      # 7) PR 생성
      - name: Create PR to manifest repo
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          path: manifest
          commit-message: "chore(ai): update image (${{ steps.target.outputs.env }}) to ${{ steps.tag.outputs.tag }}"
          title: "Deploy AI (${{ steps.target.outputs.env }}) – ${{ steps.tag.outputs.tag }}"
          body: |
            - Service: AI
            - Environment: ${{ steps.target.outputs.env }}
            - Image tag: `${{ steps.tag.outputs.tag }}`
          base: ${{ steps.target.outputs.branch }}
          branch: chore/ai-image-${{ steps.target.outputs.env }}-${{ steps.tag.outputs.tag }}
          add-paths: |
            k8s/environments/develop/values.yaml
            k8s/environments/release/values.yaml
        continue-on-error: true
